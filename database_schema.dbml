// Database: ev_rental_system

Table roles {
  role_id int [pk, increment]
  role_name varchar(50) [not null, unique, note: 'admin, staff, customer']
  description text
  created_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table users {
  user_id int [pk, increment]
  email varchar(100) [not null, unique]
  password_hash varchar(255) [not null]
  role_id int [not null, ref: > roles.role_id]
  full_name varchar(100) [not null]
  phone varchar(20) [not null, unique]
  cccd varchar(20)
  license_number varchar(50)
  address text
  position varchar(50) [note: 'chỉ dành cho staff']
  is_active boolean [default: true]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table stations {
  station_id int [pk, increment]
  name varchar(100) [not null]
  latitude decimal(10,8) [not null]
  longitude decimal(11,8) [not null]
  location varchar(100) [not null]
  status varchar(20) [default: 'active', note: 'active, inactive']
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table vehicles {
  vehicle_id int [pk, increment]
  station_id int [not null, ref: > stations.station_id]
  model varchar(100) [not null]
  brand varchar(50) [not null]
  year int
  battery_level int [not null, note: '0-100']
  max_range_km int
  status varchar(20) [default: 'available', note: 'available, rented, maintenance']
  price_per_hour decimal(10,2) [not null]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table reservations {
  reservation_id int [pk, increment]
  user_id int [not null, ref: > users.user_id]
  vehicle_id int [not null, ref: > vehicles.vehicle_id]
  station_id int [not null, ref: > stations.station_id]
  start_time datetime [not null]
  end_time datetime [not null]
  status varchar(20) [default: 'pending', note: 'pending, confirmed, cancelled, expired']
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table rentals {
  rental_id int [pk, increment]
  reservation_id int [ref: > reservations.reservation_id, note: 'liên kết với đặt xe ban đầu']
  user_id int [not null, ref: > users.user_id]
  vehicle_id int [not null, ref: > vehicles.vehicle_id]
  pickup_station_id int [not null, ref: > stations.station_id]
  return_station_id int [ref: > stations.station_id]
  start_time datetime [not null]
  end_time datetime
  status varchar(20) [default: 'pending', note: 'pending, ongoing, completed, cancelled']
  action_logs text [note: 'JSON chứa lịch sử thay đổi trạng thái']
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table payments {
  payment_id int [pk, increment]
  rental_id int [not null, ref: > rentals.rental_id]
  method_type varchar(50) [not null, note: 'cash, momo, vnpay, bank_transfer']
  amount decimal(10,2) [not null]
  status varchar(20) [not null, note: 'pending, success, failed, refunded']
  transaction_id varchar(100) [note: 'ID từ gateway thanh toán']
  is_deposit boolean [default: false]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
  updated_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table pickup_qr_codes {
  qr_id int [pk, increment]
  payment_id int [not null, ref: > payments.payment_id]
  code varchar(128) [not null, unique]
  secret_hash varchar(255) [not null]
  status varchar(20) [default: 'active', note: 'active, used, expired, revoked']
  expires_at datetime [not null]
  used_at datetime
  scanned_by varchar(20) [note: 'người quét QR']
  scan_ip varchar(45) [note: 'IP khi quét']
  scan_user_agent varchar(255) [note: 'User agent khi quét']
  created_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table handovers {
  handover_id int [pk, increment]
  rental_id int [not null, ref: > rentals.rental_id]
  staff_id int [ref: > users.user_id]
  type varchar(20) [not null, note: 'pickup, return']
  condition_notes text
  image_urls text [note: 'JSON chứa danh sách URL hình ảnh']
  image_types text [note: 'JSON chứa loại hình ảnh: before, after, damage']
  created_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table contracts {
  contract_id int [pk, increment]
  rental_id int [not null, ref: > rentals.rental_id]
  contract_url varchar(255) [not null]
  signed_at datetime
  created_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table user_documents {
  document_id int [pk, increment]
  user_id int [not null, ref: > users.user_id]
  document_type varchar(50) [not null, note: 'license, cccd, passport']
  file_url varchar(255) [not null]
  status varchar(20) [default: 'pending', note: 'pending, approved, rejected']
  uploaded_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table battery_logs {
  log_id int [pk, increment]
  vehicle_id int [not null, ref: > vehicles.vehicle_id]
  staff_id int [ref: > users.user_id]
  battery_level int [not null]
  logged_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table maintenance_records {
  maintenance_id int [pk, increment]
  vehicle_id int [not null, ref: > vehicles.vehicle_id]
  staff_id int [ref: > users.user_id]
  maintenance_type varchar(50) [not null]
  description text
  cost decimal(10,2)
  completed_at datetime
  created_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table reports {
  report_id int [pk, increment]
  station_id int [not null, ref: > stations.station_id]
  revenue decimal(15,2) [default: 0]
  utilization_rate float [default: 0]
  created_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table feedbacks {
  feedback_id int [pk, increment]
  rental_id int [not null, ref: > rentals.rental_id]
  user_id int [not null, ref: > users.user_id]
  rating int [not null, note: '1-5']
  comment text
  created_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table incidents {
  incident_id int [pk, increment]
  rental_id int [not null, ref: > rentals.rental_id]
  vehicle_id int [not null, ref: > vehicles.vehicle_id]
  staff_id int [ref: > users.user_id]
  description text
  status varchar(20) [default: 'open', note: 'open, in progress, resolved']
  created_at datetime [default: `CURRENT_TIMESTAMP`]
}

Table notifications {
  notification_id int [pk, increment]
  user_id int [not null, ref: > users.user_id]
  title varchar(200) [not null]
  message text [not null]
  type varchar(50) [not null, note: 'battery_low, rental_end, payment_success, etc.']
  is_read boolean [default: false]
  sent_at datetime [default: `CURRENT_TIMESTAMP`]
  read_at datetime
}
